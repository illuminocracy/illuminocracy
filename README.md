# Illuminocracy Facebook Advertising Analysis

This is a collection of scripts that download political advertisements from the Facebook Graph API and then upload them to Google Cloud for analysis using BigQuery.

The resulting data is used to drive a Google Data Studio dashboard that can be seen at http://www.illuminocracy.uk.

All feedback appreciated, either via GitHub or Twitter (@illuminocracyuk).  Contact me privately for access to the data generated by this code.

A word of warning: The code in this project is not the prettiest or most efficient, but was written in a bit of a hurry, so there is plenty of room for improvement.


# Dependencies
The following python libraries are required to run these scripts:
* requests
* pyyaml
* google-cloud-storage
* google-cloud-bigquery

# Scripts
These are the key scripts that are used by this project.  They should be run in the order they are listed below.

## get_ads.py
This downloads the data from the Facebook API into a local SQLite database (which is created with the DDL within the `sqlite_tables_staging.sql` file).  A valid Facebook API access token must be added to `config.yaml`.  The parameters used to query the API are hard coded in the script but could easily be changed.  The API is documented here: https://www.facebook.com/ads/library/api/?source=archive-landing-page.  The script is hard coded to only download `ACTIVE` adverts, however this can be changed for the first run by changing `ACTIVE` on the line of code below to `ALL`:

`ads_active = 'ACTIVE'`

## get_funding_affiliations.py
Once the sqlite `ads` table is populated, this script can be used to extract a CSV containing the unique Funding Entities (companies that buy ads).  This CSV should then be (manually) updated to set the party and brexit stance that each funding entity is affiliated to.  This is used by later scripts so that the ads can be categorised in these ways by the dashboard.

## get_exchange_rates.py
This script downloads currency exchange rates from a Public API so that the spend amounts for ads paid for in non-GBP currencies can be converted into GBP.  The exchange rates are stored in the sqlite database.  (In reality there are very few non-GBP ads and they are all small amounts of spend).

## load_funding_affiliations.py
Once the CSV file described above has been manually updated, this script loads the results into the sqlite database to be used in subsequent queries.

## bigquery_upload.py
This script extracts the ad data from the local sqlite database into CSV files and uploads them to Google Cloud Storage, then runs BigQuery load jobs to populate the BigQuery tables with the data.  Before running this script, the BigQuery tables must be created using the DDL within `bigquery_tables.sql`.  Also, a valid GCS key must be downloaded into a local JSON file (the name of which is hard coded into this and the next script) which has access to a GCS bucket to load the CSV files into, and the BigQuery project where the tables have been created.

## load_ads_daily_bigquery.py
This script runs a series of BigQuery SQL commands to effectively perform ETL processes to populate the various tables used by the dashboard.  To manually query the data, the key tables populated are `ads_daily`, `ads_daily_agg` and `top_ads`.

# Future Improvements
At one point, this code was intended to allow the ads to be broken down by demographic (age, gender) reach, and regional reach (although at the moment Facebook only breaks the UK down into England, Wales, Scotland etc).  This data is captured from the API but not currently used, as it was leading to large datasets being generated that could have potentially caused me to incur some BigQuery costs by exceeding the monthly free allowance.  However much of the code to do this already exists so this could easily be added.

This code also performs no analysis of the text within the ads (apart from grouping ads with identical text into a single record), however this could be an interesting exercise to attempt to measure the sentiment and key topics/issues/policies conveyed by each ad.

The code relies on a stable network connection, and if there are network issues or Facebook / Google Cloud API stability issues causing HTTP requests to fail, the scripts fall over.  This could be avoided by wrapping all the requests using the `backoff` module (at https://pypi.org/project/backoff/).

Finally, political advertising isn't confined to Facebook (although it is by far the largest digital channel).  Google provides a weekly CSV of their political ads (here: https://transparencyreport.google.com/political-ads/home?hl=en_GB).  Snapchat has a similar download (here: https://www.snap.com/en-GB/political-ads/).  I haven't attempted to analyse either of these yet.  Twitter has recently banned political ads altogether.  


This README.md was made with https://stackedit.io/.
